<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة البقالة</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#317EFB"/>
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
    <link rel="manifest" href="manifest.webmanifest">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>

    <div id="login-screen">
        <form id="login-form">
            <h2>تسجيل الدخول</h2>
            <div id="login-error" class="error-message hidden"></div>
            <div>
                <label for="username">اسم المستخدم:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div>
                <label for="pin">الرقم السري (PIN):</label>
                <input type="password" id="pin" name="pin" required pattern="[0-9]*" inputmode="numeric">
            </div>
            <button type="submit">دخول</button>
        </form>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <h1>نظام إدارة البقالة - PWA</h1>
        </header>

        <main id="app-main">
            <!-- Views will be inserted here -->
            <div id="pos-view" class="view hidden pos-grid-container">
                <div class="pos-product-grid">
                    <div class="pos-search-bar">
                        <input type="text" id="pos-search-input" placeholder="ابحث عن منتج..." maxlength="100">
                    </div>
                    <div id="pos-product-list" class="pos-product-list">
                        <!-- Product cards will be rendered here by JS -->
                    </div>
                </div>
                <div class="pos-cart">
                    <h3>الفاتورة الحالية</h3>
                    <ul id="pos-cart-items">
                        <!-- Cart items will be rendered here by JS -->
                    </ul>
                    <div class="pos-cart-summary">
                        <div><span>الإجمالي:</span> <span id="cart-total">0.00</span></div>
                        <div>
                            <label for="cart-discount">خصم:</label>
                            <input type="number" id="cart-discount" value="0" step="0.01" min="0">
                        </div>
                        <div class="total"><span>الإجمالي النهائي:</span> <span id="cart-final-total">0.00</span></div>
                    </div>
                    <div class="pos-cart-actions">
                        <button id="pos-pay-cash">نقدي</button>
                        <button id="pos-pay-card">بطاقة</button>
                        <button id="pos-pay-credit">آجل</button>
                        <button id="pos-clear-cart">إلغاء</button>
                    </div>
                </div>
            </div>

            <div id="inventory-view" class="view hidden">
                <h2>إدارة المخزون</h2>
                <button id="add-product-btn">إضافة منتج جديد</button>
                <form id="product-form" class="hidden">
                    <h3>إضافة/تعديل منتج</h3>
                    <input type="hidden" id="product-id">
                    <div>
                        <label for="product-name">اسم المنتج:</label>
                        <input type="text" id="product-name" required maxlength="100">
                    </div>
                    <div>
                        <label for="product-barcode">الباركود:</label>
                        <input type="text" id="product-barcode" maxlength="50">
                        <button type="button" id="scan-barcode-btn">مسح</button>
                    </div>
                    <div>
                        <label for="product-category">الفئة:</label>
                        <input type="text" id="product-category" maxlength="50">
                    </div>
                     <div>
                        <label for="product-unit">وحدة القياس (eg. kg, pcs):</label>
                        <input type="text" id="product-unit" maxlength="20">
                    </div>
                    <div>
                        <label for="product-purchase-cost">تكلفة الشراء:</label>
                        <input type="number" id="product-purchase-cost" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="product-sale-price">سعر البيع:</label>
                        <input type="number" id="product-sale-price" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="product-stock">الكمية الحالية:</label>
                        <input type="number" id="product-stock" step="1" min="0" required>
                    </div>
                    <div>
                        <label for="product-low-stock-alert">تنبيه انخفاض المخزون عند:</label>
                        <input type="number" id="product-low-stock-alert" step="1" min="0">
                    </div>
                    <button type="submit">حفظ المنتج</button>
                    <button type="button" id="cancel-product-form-btn">إلغاء</button>
                </form>
                <table id="products-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الباركود</th>
                            <th>الفئة</th>
                            <th>الكمية</th>
                            <th>سعر البيع</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Products will be listed here -->
                    </tbody>
                </table>
            </div>

            <div id="suppliers-view" class="view hidden">
                <h2>إدارة الموردين</h2>
                <button id="add-supplier-btn">إضافة مورد جديد</button>
                <button id="new-purchase-invoice-btn">فاتورة شراء جديدة</button>
                <form id="supplier-form" class="hidden">
                    <h3>إضافة/تعديل مورد</h3>
                    <input type="hidden" id="supplier-id">
                    <div>
                        <label for="supplier-name">اسم المورد:</label>
                        <input type="text" id="supplier-name" required maxlength="100">
                    </div>
                    <div>
                        <label for="supplier-contact">معلومات الاتصال:</label>
                        <input type="text" id="supplier-contact" maxlength="100">
                    </div>
                    <div>
                        <label for="supplier-balance">الرصيد:</label>
                        <input type="number" id="supplier-balance" readonly value="0">
                    </div>
                    <button type="submit">حفظ المورد</button>
                    <button type="button" id="cancel-supplier-form-btn">إلغاء</button>
                </form>
                <table id="suppliers-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>معلومات الاتصال</th>
                            <th>الرصيد</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="suppliers-table-body">
                        <!-- Suppliers will be listed here -->
                    </tbody>
                </table>
            </div>

            <div id="customers-view" class="view hidden">
                <h2>إدارة العملاء</h2>
                <button id="add-customer-btn">إضافة عميل جديد</button>
                <form id="customer-form" class="hidden">
                    <h3>إضافة/تعديل عميل</h3>
                    <input type="hidden" id="customer-id">
                    <div>
                        <label for="customer-name">اسم العميل:</label>
                        <input type="text" id="customer-name" required maxlength="100">
                    </div>
                    <div>
                        <label for="customer-phone">الهاتف:</label>
                        <input type="text" id="customer-phone" maxlength="20">
                    </div>
                    <div>
                        <label for="customer-balance">الرصيد:</label>
                        <input type="number" id="customer-balance" readonly value="0">
                    </div>
                    <button type="submit">حفظ العميل</button>
                    <button type="button" id="cancel-customer-form-btn">إلغاء</button>
                </form>
                <table id="customers-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الرصيد</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table-body">
                        <!-- Customers will be listed here -->
                    </tbody>
                </table>
            </div>

            <div id="reports-view" class="view hidden">
                <h2>التقارير</h2>
                <nav class="sub-nav">
                    <button data-report="sales">المبيعات والأرباح</button>
                    <button data-report="stock-value">قيمة المخزون</button>
                    <button data-report="low-stock">نقص المخزون</button>
                </nav>
                <div class="report-controls">
                    <label for="report-start-date">من:</label>
                    <input type="date" id="report-start-date">
                    <label for="report-end-date">إلى:</label>
                    <input type="date" id="report-end-date">
                    <button id="generate-report-btn">إنشاء</button>
                    <button id="export-csv-btn">تصدير CSV</button>
                    <button id="print-report-btn">طباعة</button>
                </div>
                <div id="report-output">
                    <!-- Report content will be rendered here -->
                </div>
            </div>

            <div id="backup-view" class="view hidden">
                <h2>النسخ الاحتياطي والاستعادة</h2>
                <p>قم بتصدير جميع بيانات التطبيق إلى ملف JSON واحد يمكنك حفظه بشكل آمن.</p>
                <button id="export-btn">تصدير نسخة احتياطية</button>
                <hr>
                <p>استعادة البيانات من ملف نسخة احتياطية. **تحذير:** سيؤدي هذا إلى مسح جميع البيانات الحالية بشكل دائم.</p>
                <input type="file" id="import-file-input" accept=".json">
                <button id="import-btn" disabled>استعادة من ملف</button>
            </div>
        </main>

        <footer>
            <button id="load-sample-data-btn">تحميل بيانات عيّنة</button>
            <p>الحالة: <span id="status-indicator">غير متصل</span></p>
        </footer>
    </div>

    <div id="scanner-modal" class="modal hidden">
        <div class="modal-content">
            <h3>مسح الباركود</h3>
            <video id="scanner-video" style="width: 100%; border: 1px solid grey;"></video>
            <button id="close-scanner-btn">إلغاء</button>
        </div>
    </div>

    <div id="stock-adjustment-modal" class="modal hidden">
        <div class="modal-content">
            <h3>تعديل المخزون لـ <span id="adj-product-name"></span></h3>
            <form id="stock-adjustment-form">
                <input type="hidden" id="adj-product-id">
                <div>
                    <label for="adj-type">نوع التعديل:</label>
                    <select id="adj-type" required>
                        <option value="purchase">شراء (إضافة)</option>
                        <option value="return">إرجاع (خصم)</option>
                        <option value="loss">تالف/مفقود (خصم)</option>
                    </select>
                </div>
                <div>
                    <label for="adj-quantity">الكمية:</label>
                    <input type="number" id="adj-quantity" min="1" required>
                </div>
                <div>
                    <label for="adj-notes">ملاحظات:</label>
                    <input type="text" id="adj-notes">
                </div>
                <button type="submit">حفظ التعديل</button>
                <button type="button" id="close-adj-modal-btn">إلغاء</button>
            </form>
        </div>
    </div>

    <div id="purchase-invoice-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <h3>فاتورة شراء جديدة</h3>
            <form id="purchase-invoice-form">
                <div>
                    <label for="purchase-supplier-select">المورد:</label>
                    <select id="purchase-supplier-select" required></select>
                </div>
                <table id="purchase-items-table">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>تكلفة الوحدة</th>
                            <th>الإجمالي</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="purchase-items-body">
                        <!-- Purchase items will be added here by JS -->
                    </tbody>
                </table>
                <button type="button" id="add-purchase-item-btn">إضافة منتج</button>
                <div class="totals">
                    <strong>الإجمالي النهائي: <span id="purchase-total">0.00</span></strong>
                </div>
                <button type="submit">حفظ الفاتورة</button>
                <button type="button" id="close-purchase-invoice-btn">إلغاء</button>
            </form>
        </div>
    </div>

    <div id="customer-payment-modal" class="modal hidden">
        <div class="modal-content">
            <h3>تسجيل دفعة لـ <span id="payment-customer-name"></span></h3>
            <form id="customer-payment-form">
                <input type="hidden" id="payment-customer-id">
                <div>
                    <label for="payment-amount">المبلغ المدفوع:</label>
                    <input type="number" id="payment-amount" min="0.01" step="0.01" required>
                </div>
                <button type="submit">حفظ الدفعة</button>
                <button type="button" id="close-payment-modal-btn">إلغاء</button>
            </form>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/pos.js"></script>
    <script src="js/suppliers.js"></script>
    <script src="js/purchases.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/backup.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
